const startBtn=document.getElementById('startBtn'),skipBtn=document.getElementById('skipBtn'),intro=document.getElementById('intro'),stage=document.getElementById('stage'),poemEl=document.getElementById('poem'),musicInput=document.getElementById('musicInput'),photoUpload=document.getElementById('photoUpload'),thumbs=document.getElementById('thumbs'),petalCanvas=document.getElementById('petalLayer'),ctx=petalCanvas.getContext('2d');let audio=new Audio(),playing=false;const poemLines=["雨落长街，灯影里有你的温柔，","风拂柳岸，心事只愿寄与你眉间。","半盏茶凉，十年荒烟，我只念一人：雨汐。","若得岁月，愿与汝共织此生温柔。"];function typePoem(target,lines,speed=45){target.textContent='';let i=0;function nextLine(){if(i>=lines.length) return;let line=lines[i],j=0;const t=setInterval(()=>{if(j<line.length) target.textContent+=line[j++];else{clearInterval(t);target.textContent+='\n';i++;setTimeout(nextLine,400);}},speed);}nextLine();}function fitCanvas(){petalCanvas.width=window.innerWidth;petalCanvas.height=window.innerHeight;}window.addEventListener('resize',fitCanvas);fitCanvas();const petals=[],petalImg=new Image();petalImg.src='./flower.png';function spawnPetal(x,y){petals.push({x:x,y:y,vx:(Math.random()*2-1)*1.2,vy:(1+Math.random()*1.6)*0.6,angle:Math.random()*Math.PI*2,aVel:(Math.random()*2-1)*0.04,size:18+Math.random()*50});}function updatePetals(){ctx.clearRect(0,0,petalCanvas.width,petalCanvas.height);for(let i=petals.length-1;i>=0;i--){const p=petals[i];p.vy+=0.02+Math.sin(performance.now()/1e3+p.x*0.001)*0.002;p.vx+=Math.sin(performance.now()/1e3*0.6+p.y*0.001)*0.0015;p.x+=p.vx;p.y+=p.vy;p.angle+=p.aVel;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.angle);const s=p.size;ctx.drawImage(petalImg,-s/2,-s/2,s,s);ctx.restore();if(p.y>petalCanvas.height*0.95||p.x<-200||p.x>petalCanvas.width+200)petals.splice(i,1);}requestAnimationFrame(updatePetals);}requestAnimationFrame(updatePetals);function bloom(){const w=petalCanvas.width;for(let i=0;i<90;i++){const sx=w*(0.25+Math.random()*0.5);spawnPetal(sx,-20-Math.random()*120);}}startBtn.addEventListener('click',()=>{bloom();setTimeout(()=>enterStage(),1500);});skipBtn.addEventListener('click',enterStage);function enterStage(){intro.classList.add('hidden');stage.classList.remove('hidden');typePoem(poemEl,poemLines,40);}document.getElementById('loadMusic').addEventListener('click',()=>{let name=musicInput.value.trim();if(!name) name='music';if(/\.[a-z0-9]+$/i.test(name)) audio.src='./'+name;else{audio.src='./'+name+'.mp3';audio.onerror=()=>{audio.src='./'+name+'.flac';};}showNotice('尝试加载：'+audio.src);});document.getElementById('playMusic').addEventListener('click',async ()=>{try{if(playing){audio.pause();playing=false;document.getElementById('playMusic').textContent='播放/暂停';}else{await audio.play();playing=true;document.getElementById('playMusic').textContent='暂停';}}catch(e){showNotice('播放失败：请先与页面交互或确认文件存在。');}});photoUpload.addEventListener('change',async(ev)=>{const files=Array.from(ev.target.files||[]);for(const f of files){const url=URL.createObjectURL(f);const thumb=document.createElement('div');thumb.className='thumb';const img=document.createElement('img');img.src=url;thumb.appendChild(img);thumbs.appendChild(thumb);}});document.getElementById('addFromFolder').addEventListener('click',()=>{const csv=prompt('在仓库中图片相对路径（逗号分隔），例如 img1.jpg,img2.jpg');if(!csv) return;const names=csv.split(',').map(s=>s.trim()).filter(Boolean);for(const n of names){const thumb=document.createElement('div');thumb.className='thumb';const img=document.createElement('img');img.src='./'+n;img.onerror=()=>{img.style.opacity=0.4;img.alt='未找到';};thumb.appendChild(img);thumbs.appendChild(thumb);}});const noticeEl=document.createElement('div');noticeEl.style.position='fixed';noticeEl.style.right='16px';noticeEl.style.bottom='20px';noticeEl.style.padding='8px 12px';noticeEl.style.background='rgba(0,0,0,0.6)';noticeEl.style.color='#fff';noticeEl.style.borderRadius='8px';noticeEl.style.display='none';document.body.appendChild(noticeEl);function showNotice(msg,tm=3200){noticeEl.textContent=msg;noticeEl.style.display='block';setTimeout(()=>noticeEl.style.display='none',tm);}fetch('./music.mp3').then(r=>{if(r.ok) document.getElementById('musicInput').value='music';}).catch(()=>{});fetch('./music.flac').then(r=>{if(r.ok) document.getElementById('musicInput').value='music';}).catch(()=>{});